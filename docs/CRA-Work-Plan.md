# AIBoMGen CRA-Oriented Version: Implementation Work Plan

This plan delivers a consumer-ready (CRA-oriented) AIBoM generator tailored for PDE (Product with Digital Elements) manufacturers, optimized for embedding in CI/CD pipelines and OTA workflows. It prioritizes trusted model sources (e.g., Hugging Face), minimal dependencies, offline capability, and CycloneDX/SPDX compliance.

---

## 1. Scope and Goals

- Deliver a lightweight AIBoM generator (CLI + Python API) producing CycloneDX/SPDX compliant AIBOMs.
- Assume trusted model developers; support developer-signed model metadata and verification.
- Integrate Hugging Face metadata retrieval with optional offline cache.
- Integrate vulnerability data (OSV/NVD) for runtime and system dependencies.
- Optimize for CI/CD (e.g., GitHub Actions) and OTA/device inventory workflows.

## 2. Target Users and Environments

- PDE manufacturers (e.g., smart doorbells, edge devices) integrating public or private Hugging Face models.
- Build pipelines: GitHub Actions, GitLab CI, local builds.
- Environments: Linux-based CI, containerized builders, constrained edge build hosts.

## 3. Requirements Mapping

### 3.1 Functional
- AIBOM schema focused on:
  - AI components (models, versions, sources, hashes, signatures)
  - Runtime (frameworks, Python version, CUDA/cuDNN if applicable)
  - System dependencies (OS packages, drivers, firmware modules as provided)
- OTA-friendly artifact identification (artifact_id, versions, immutable hashes)
- Trusted developer assumption + signed metadata verification (Ed25519/JWS)
- Automatic Hugging Face metadata retrieval (model card, tags, licenses, files)
- Vulnerability integration (OSV, NVD), annotate AIBOM with vulnerabilities and severity
- CLI and Python API suitable for CI/CD
- Output formats: CycloneDX JSON, SPDX JSON; versioned schema validation

### 3.2 Non-functional
- Minimal dependencies; fast execution
- Runs offline (no network) using provided manifests and cached metadata
- JSON schema versioning + validation
- Stable, deterministic outputs (sorted fields, pinned versions)

## 4. Architecture Overview

### 4.1 Components
- Core data models: pydantic/dataclasses for AIBOM entities
- Schema module: versioned JSON Schema, validators
- HF Metadata fetcher: online (Hugging Face Hub API) + offline cache (JSON files)
- Dependency resolver:
  - Python: parse `runtime_requirements.txt`; optional environment introspection
  - System: read `manifests/system.json` and optional OS package manifest
- Vulnerability scanner:
  - OSV API for Python packages (and optionally OS packages via ecosystem mapping)
  - Optional NVD integration (via local mirror or API), configurable
- SBOM importer:
  - CycloneDX JSON ingestion (e.g., generated by Trivy) to merge dependencies and vulnerabilities into AIBOM
- Signing & verification:
  - Developer-signed model metadata (Ed25519/JWS file or detached signature)
  - Verification step before AIBOM generation
- Generators:
  - CycloneDX JSON generator (1.5/1.6)
  - SPDX JSON (2.3) generator
- CLI:
  - Subcommands for generate, validate, cache, verify-signature
- Python API:
  - Importable functions to compose pipeline steps

### 4.2 Data Flow (Doorbell example)
1. Inputs: `manifests/system.json`, `manifests/runtime_requirements.txt`, model id `openai/fast-object-detector`, optional signed model metadata
2. Resolve model metadata from Hugging Face or offline cache
3. Verify model metadata signature (if provided)
4. Parse Python/system dependencies
5. Query vulnerabilities (online or from offline mirror if configured)
6. Produce CycloneDX/SPDX compliant AIBOM JSON
7. Emit to `dist/aibom.json` and optionally upload artifact in CI

### 4.3 Storage and Caching
- Local cache directory: `.aibom-cache/` storing HF model metadata JSON and checksums
- Vulnerability cache: persisted OSV results keyed by package@version, TTL configurable

## 5. Deliverables
- CLI tool `aibom-cra` (Python entry point)
- Python library module `aibomcra` with API
- JSON Schemas for AIBOM, CycloneDX/SPDX mapping docs
- Example project: doorbell (PDE) with manifests and CI workflow
- Documentation: usage, offline mode, signing, CI integration

## 6. Milestones and Phases

### Phase 0: Project Scaffolding
- Tasks:
  - Create package structure (`aibomcra/`), `pyproject.toml`, minimal `README`
  - Set up `tox`/`pytest` and basic CI
- Acceptance:
  - `pip install -e .` works; `aibom-cra --help` prints usage

### Phase 1: Core Schema + Output Skeleton
- Tasks:
  - Define internal AIBOM models and JSON Schemas with versioning
  - Implement serializer with deterministic formatting
- Acceptance:
  - `aibom-cra generate --dry-run` emits valid base AIBOM (no metadata yet)

### Phase 2: Hugging Face Metadata + Offline Cache
- Tasks:
  - Implement HF metadata retrieval (model card, files, sha256, license, tags)
  - Add `--offline` and `--cache-dir`
- Acceptance:
  - Online run fetches and caches metadata; offline run uses cache only

### Phase 3: Dependency Resolution
- Tasks:
  - Primary path (SBOM-only): import CycloneDX from Trivy and use it as source of runtime/system deps
  - Optional: parse `manifests/runtime_requirements.txt` (pip-style) to supplement when SBOM unavailable
  - Optional: ingest `manifests/system.json` to add device-specific components when not present in SBOM
- Acceptance:
  - Dependencies correctly included from SBOM; manifests are optional supplements

### Phase 4: Vulnerability Integration
- Tasks:
  - OSV queries for Python deps; annotate components with CVEs + severity
  - Optional NVD integration (config flag) and severity normalization (CVSS)
- Acceptance:
  - AIBOM contains vulnerability findings with IDs, severity, and affected components

### Phase 4b: Trivy SBOM Import (CycloneDX)
- Tasks:
  - Add CycloneDX importer to read SBOMs produced by Trivy (`trivy sbom` or `trivy fs`)
  - Map CycloneDX components to AIBOM runtime/system dependencies
  - Ingest vulnerabilities from CycloneDX "vulnerabilities" section when present
  - Reconcile duplicates between local parsing and imported SBOM (prefer imported exact versions)
  - Support multiple `--import-sbom` inputs and aggregate (e.g., app SBOM + image SBOM)
- Acceptance:
  - `aibom-cra generate --import-sbom dist/sbom.json ...` merges dependencies and vulnerabilities deterministically
  - Works when OSV/NVD is disabled (use Trivy-only data) and when combined

### Phase 5: Signing & Verification
- Tasks:
  - Ed25519 keypair how-to; support verifying developer-signed model metadata (JWS or detached)
  - Optional signing of final AIBOM artifact (detached signature)
- Acceptance:
  - `aibom-cra verify --model-metadata model.json --sig model.json.sig --pubkey pub.pem` passes/fails correctly

### Phase 6: Performance & Minimal Dependencies
- Tasks:
  - Optimize API calls, caching, and parallelization of OSV lookups
  - Extras flags: `minimal` install vs `full` (with validators, NVD)
- Acceptance:
  - Cold run < ~5s typical; cached runs < ~2s (CI small projects)

### Phase 7: CI/CD Integration
- Tasks:
  - Provide GitHub Actions workflow and GitLab template
  - Artifacts, cache usage, and PR annotations for vulnerabilities (optional)
- Acceptance:
  - Example workflow generates `dist/aibom.json` and uploads artifact

### Phase 8: Docs & Examples
- Tasks:
  - Doorbell example repo structure, manifests, and sample outputs
  - How-tos: offline, signing, custom schemas, SBOM+AIBOM bundling
- Acceptance:
  - Users can reproduce example output with provided commands

### Phase 9: Packaging & Release
- Tasks:
  - Versioning strategy (CalVer or SemVer); schema version bump policy
  - PyPI releases, GitHub Releases, changelog
- Acceptance:
  - `pip install aibomcra` installs CLI; docs linked in release

## 7. Detailed Task Breakdown

### 7.1 CLI and Python API
- Implement commands:
  - `generate`: Produce AIBOM; flags: `--model-id`, `--system`, `--requirements`, `--output`, `--format cyclonedx|spdx`, `--offline`, `--cache-dir`, `--sign-aibom`, `--aibom-sign-key`
  - `validate`: Validate AIBOM against schema version
  - `cache pull`: Pre-fetch HF metadata into cache
  - `verify`: Verify signed model metadata
- Python API:
  - `generate_aibom(model_id, system_manifest, requirements, options) -> dict`
  - `validate_aibom(aibom: dict) -> ValidationResult`

Additions for Trivy/CycloneDX integration:
- `generate` adds: `--import-sbom PATH` (repeatable) to import CycloneDX JSON from Trivy and `--prefer-imported` (if conflicts)
- Python API adds optional parameter: `imported_sbom: list[dict] | None`

### 7.2 HF Metadata Retrieval
- Data: model id, revision, files list with checksums, license, tags
- Sources: Hugging Face Hub API (`huggingface_hub` or HTTP/requests to public endpoints)
- Offline: cache JSON under `.aibom-cache/hf/{model_id}/{rev}.json`

### 7.3 Signed Metadata
- Format options:
  - Detached Ed25519 signature over canonicalized JSON (minified, UTF-8)
  - Or JWS JSON with embedded signature
- Verification:
  - Input pubkey PEM; verify signature before use
- Key management docs for developers

### 7.4 Vulnerability Data
- Primary: OSV API queries for `PyPI` ecosystem packages `name@version`
- Optional: NVD (via local mirror or API), map CVSS to severity
- Output:
  - For each component: `vulnerabilities: [{id, source, severity, affected_range}]`
- Offline mode:
  - Skip queries or use pre-fetched advisories from cache directory

With Trivy SBOM import:
- Accept vulnerabilities embedded in CycloneDX (from Trivy) with `source: "trivy"` or original advisory source
- Normalize severity (map to CVSS or standardized levels) without losing original scores

### 7.5 Output Formats
- CycloneDX JSON 1.5/1.6 minimal profile
  - Components: model, runtime, packages; vulnerabilities section
  - Map hashes to `hashes` entries; licenses; externalReferences (HF URL)
- SPDX JSON 2.3
  - Packages and relationships; Model as a Package with `SPDXID`
- Validation with JSON Schema and/or libraries (optional extra)

### 7.6 Offline Mode
- Flags: `--offline`, `--cache-dir`
- Behavior: use manifests + cache only; no network calls; emit warnings if cache missing

### 7.7 Performance
- OSV queries batched or parallelized with rate limiting
- Cache all network results; stable hashing for cache keys
- Lazy validation; fast JSON serialization

## 8. Example Inputs and Manifests

`manifests/system.json`
```json
{
  "artifact_id": "pde-doorbell-v1.2.0",
  "producer": {
    "system_id": "doorbell-vendor-x",
    "component": "PDE-doorbell-firmware",
    "contact": "devops@vendorx.com"
  },
  "system_components": [
    { "name": "linux-kernel", "version": "6.1.54" },
    { "name": "libcamera", "version": "0.1.0" }
  ]
}
```

`manifests/runtime_requirements.txt`
```
torch==2.4.0
transformers==4.43.3
numpy==1.26.4
```

## 9. GitHub Actions Workflow (Example)

`.github/workflows/aibom.yml`
```yaml
name: AIBoM (CRA)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  generate-aibom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install aibomcra
        run: |
          python -m pip install --upgrade pip
          pip install aibomcra

      # Optional: integrate Trivy to import CycloneDX SBOM and vulnerabilities
      - name: Install Trivy
        uses: aquasecurity/trivy-action@0.24.0

      - name: Generate SBOM with Trivy (CycloneDX)
        run: |
          mkdir -p dist
          trivy sbom . -f cyclonedx -o dist/sbom.json

      - name: Cache AIBoM metadata
        uses: actions/cache@v4
        with:
          path: .aibom-cache
          key: aibomcache-${{ runner.os }}-${{ hashFiles('manifests/**', 'requirements.txt') }}

      - name: Generate AIBOM
        run: |
          mkdir -p dist
          aibom-cra generate \
            --model-id "openai/fast-object-detector" \
            --import-sbom dist/sbom.json \
            --format cyclonedx \
            --cache-dir .aibom-cache \
            --output dist/aibom.json

      - name: Validate AIBOM
        run: |
          aibom-cra validate --input dist/aibom.json

      - name: Upload AIBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: aibom
          path: dist/aibom.json
```

Notes:
- For private models, add `HUGGINGFACE_TOKEN` secret and export as env var before `generate`.
- To run offline, add `--offline` and ensure metadata is cached.
- If Trivy is unavailable or undesired, omit the Trivy steps and the `--import-sbom` flag; OSV/NVD queries still annotate vulnerabilities if enabled.

SBOM-only guidance:
- For application repos, `trivy sbom . -f cyclonedx` captures application dependencies.
- For container images/firmware, additionally import image/rootfs SBOM via `trivy image` or `trivy rootfs` and pass both files by repeating `--import-sbom`.

## 10. Testing Strategy
- Unit tests for:
  - Schema models and validation
  - HF fetcher (mocked) + cache logic
  - Vulnerability annotator (mock OSV responses)
  - Signing/verification (key fixtures)
  - Generators for CycloneDX/SPDX (golden file comparison)
- Integration test:
  - Doorbell example: end-to-end `generate` producing deterministic AIBOM

## 11. Security and Threat Model
- Trusted developer model: signature verification ensures provenance of model metadata
- Handle untrusted network input defensively (timeouts, schema validation)
- Avoid executing model artifacts; only metadata reads
- Optional signing of final AIBOM for chain-of-custody

## 12. Versioning and Schema Management
- Schema versions: `aibom-cra:1.0.0`, mapped to output CycloneDX/SPDX versions
- Backward-compatible changes prefer additive fields
- Validation tool supports `--schema-version`

## 13. Backlog and Extensions
- Merge multiple HF models into single AIBOM
- Export SBOM + AIBOM bundle
- Model card trust scores integration
- NVD local mirror ingestion for full offline vulnerability coverage
- Trivy plugin wrapper: expose `trivy aibom` plugin that runs Trivy SBOM generation then invokes `aibom-cra` under the hood

## 14. Risks and Mitigations
- Rate limits/availability of APIs → aggressive caching, offline mode
- Library bloat → optional extras; pure-Python minimal default
- SPDX/CycloneDX schema drift → pin versions; add schema version flags

## 15. Success Metrics
- CI runtime overhead < 10s (cold) / < 3s (cached)
- 0 schema validation errors across examples
- High cache hit rate in repeated CI runs (>80%)

## 16. Timeline (Indicative)
- Week 1: Phases 0–2 (scaffold, schema, HF + cache)
- Week 2: Phases 3–4 (deps + vulnerabilities)
- Week 3: Phases 5–7 (signing, perf, CI workflows)
- Week 4: Phases 8–9 (docs, examples, release)

---

## 17. Quick Start (Local)
```
pip install aibomcra
mkdir -p dist .aibom-cache
aibom-cra generate \
  --model-id "openai/fast-object-detector" \
  --system manifests/system.json \
  --requirements manifests/runtime_requirements.txt \
  --format cyclonedx \
  --cache-dir .aibom-cache \
  --output dist/aibom.json
```

This plan intentionally focuses on a minimal, fast, and CI-friendly implementation with clear extension points for broader SBOM/AIBOM convergence and deeper vulnerability coverage.
